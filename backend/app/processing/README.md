# APH-IF Backend Processing Module

This package provides processing utilities used by the APH-IF backend service:

- Asynchronous, cached citation extraction used by the fusion layer
- Optional process-level parallel execution helpers to achieve true parallelism

The module is intended to be imported by other backend components; it is not an
entrypoint or a standalone service.

## Components

- `citation_processor.py`
  - `AsyncCitationProcessor`: async citation and references extraction with TTL caching
  - Public helpers (re-exported by this package):
    - `get_citation_processor()` — returns a singleton processor instance
    - `shutdown_citation_processor()` — gracefully cleans up background tasks
- `process_parallel.py`
  - Process-level helpers for running semantic/traversal searches in isolated OS processes
  - Typically leveraged indirectly by the parallel hybrid engine
- `__init__.py`
  - Re-exports canonical entrypoints for convenient imports from `app.processing`

## Quick usage

Import from the package root for a stable API surface:

```python
from app.processing import (
    get_citation_processor,
    shutdown_citation_processor,
    get_process_parallel_engine,
)

# Async citation extraction
processor = get_citation_processor()
citations = await processor.extract_citations_async(text)
references = await processor.extract_references_async(text)

# When your application is shutting down
await shutdown_citation_processor()
```

Notes:
- The process-level engine (`get_process_parallel_engine`) is primarily used internally by the
  parallel hybrid retrieval flow. Most applications should not call it directly unless they
  understand the concurrency and lifecycle implications.

## Concurrency and lifecycle

- `AsyncCitationProcessor` uses an in-memory TTL cache and maintains a set of background asyncio
  tasks for fire-and-forget extraction. Use the provided `shutdown_citation_processor()` to ensure
  proper cleanup during application shutdown.
- The process-parallel helpers spawn separate OS processes to eliminate shared client/driver state
  when running semantic and traversal search legs in parallel. They should be treated as advanced
  utilities.

## Integration with the backend

- The FastAPI application wires the citation processor during startup and uses it in fusion logic.
- The parallel hybrid engine may leverage process-level helpers depending on configuration and use
  case.

## Development

Run within the `backend/` service directory using the project’s `uv` workflow.

- Start API (dev):
  ```bash
  uv run uvicorn app.main:app --reload
  ```
- Tests (filter example):
  ```bash
  uv run pytest -q -k processing
  ```

## License

Apache-2.0. See repository root for full license text.

(Generated by AI)